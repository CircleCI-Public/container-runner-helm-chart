version: 2.1

orbs:
  slack: circleci/slack@4.10.1
  aws-cli: circleci/aws-cli@0.1.20

workflows:
  main-workflow:
    jobs:
      - check-version-bump
      - validate-helm-chart:
          requires:
            - check-version-bump
      - package-cloud-helm-chart:
          publish: true
          context: org-global
          filters:
            branches:
              only:
                - main
          requires:
            - validate-helm-chart
            - check-version-bump
      - package-cloud-helm-chart:
          name: dry-run-package-cloud
          publish: false
          context: org-global
          filters:
            branches:
              ignore:
                - main
                - canary
          requires:
            - check-version-bump

jobs:
  check-version-bump:
    docker:
      - image: cimg/base:stable
    resource_class: medium
    steps:
      - checkout
      - run: ./do check-version-bump << pipeline.git.branch >>

  validate-helm-chart:
    docker:
      - image: cimg/python:3.10
    resource_class: medium
    steps:
      - checkout
      - aws-cli/setup:
          profile-name: cci
          aws-access-key-id: BINARY_S3_AWS_ACCESS_KEY_ID
          aws-secret-access-key: BINARY_S3_AWS_SECRET_ACCESS_KEY
      - run: ./do install-helm
      - run: helm lint
      - run: ./do provision-test
      - notify_failing_main

  package-cloud-helm-chart:
    docker:
      - image: cimg/python:3.10
    resource_class: medium
    parameters:
      publish:
        type: boolean
        default: true
    steps:
      - checkout
      - attach_workspace:
          at: .
      - aws-cli/setup:
          profile-name: cci
          aws-access-key-id: BINARY_S3_AWS_ACCESS_KEY_ID
          aws-secret-access-key: BINARY_S3_AWS_SECRET_ACCESS_KEY
      - run: sudo apt update
      - run: ./do install-helm
      - run: sudo apt install ruby-dev
      - run: sudo gem install package_cloud
      - run: ./do package-cloud-helm << parameters.publish >>
      - notify_failing_main

commands:
  notify_failing_main:
    steps:
      - slack/notify:
          channel: runner-alerts
          branch_pattern: main
          event: fail
          template: basic_fail_1
