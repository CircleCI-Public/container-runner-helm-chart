version: 2.1

orbs:
  slack: circleci/slack@4.10.1
  aws-cli: circleci/aws-cli@0.1.20

workflows:
  main-workflow:
    jobs:
      - check-verison-bump
      - package-helm-chart:
          context: org-global
          publish: true
          filters:
            branches:
              only:
                - main
          requires:
            - check-verison-bump
      - package-helm-chart:
          name: dry-run-package
          publish: false
          context: org-global
          filters:
            branches:
              ignore:
                - main
                - canary
          requires:
            - check-verison-bump
      - package-cloud-helm-chart:
          publish: true
          context: org-global
          filters:
            branches:
              only:
                - main
          requires:
            - check-verison-bump
      - package-cloud-helm-chart:
          name: dry-run-package-cloud
          publish: false
          context: org-global
          filters:
            branches:
              ignore:
                - main
                - canary
          requires:
            - check-verison-bump

jobs:
  check-verison-bump:
    docker:
      - image: cimg/base:stable
    resource_class: medium
    steps:
      - checkout
      - when:
          condition:
            equal: [ << pipeline.git.branch >>, main ]
          steps:
            - run: |
                if [ "$(./do version)" == "$(git show HEAD^:Chart.yaml | grep version | sed -nE 's/.*"(.*)".*/\1/p')" ]; then
                  exit 1
                else
                  exit 0
                fi
      - when:
          condition:
            not:
              equal: [ << pipeline.git.branch >>, main]
          steps:
            - run: |
                if [ "$(./do version)" == "$(git show main:Chart.yaml | grep version | sed -nE 's/.*"(.*)".*/\1/p')" ]; then
                  exit 1
                else
                  exit 0
                fi

  package-helm-chart:
    docker:
      - image: cimg/python:3.10
    resource_class: medium
    parameters:
      publish:
        type: boolean
        default: true
    steps:
      - checkout
      - attach_workspace:
          at: .
      - aws-cli/setup:
          profile-name: cci
          aws-access-key-id: BINARY_S3_AWS_ACCESS_KEY_ID
          aws-secret-access-key: BINARY_S3_AWS_SECRET_ACCESS_KEY
      - run: ./do install-helm
      - run: ./do package-helm << parameters.publish >>
      - persist_to_workspace:
          root: .
          paths:
            - helm-package
      - notify_failing_main

  package-cloud-helm-chart:
    docker:
      - image: cimg/python:3.10
    resource_class: medium
    parameters:
      publish:
        type: boolean
        default: true
    steps:
      - checkout
      - attach_workspace:
          at: .
      - aws-cli/setup:
          profile-name: cci
          aws-access-key-id: BINARY_S3_AWS_ACCESS_KEY_ID
          aws-secret-access-key: BINARY_S3_AWS_SECRET_ACCESS_KEY
      - run: sudo apt update
      - run: ./do install-helm
      - run: sudo apt install ruby-dev
      - run: sudo gem install package_cloud
      - run: ./do package-cloud-helm << parameters.publish >>
      - notify_failing_main

commands:
  notify_failing_main:
    steps:
      - slack/notify:
          channel: runner-alerts
          branch_pattern: main
          event: fail
          template: basic_fail_1
