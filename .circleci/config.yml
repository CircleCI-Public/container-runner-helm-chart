version: 2.1

orbs:
  slack: circleci/slack@4.12.5

workflows:
  main-workflow:
    jobs:
      - validate
      - package

      - approve-publish:
          type: approval
          filters:
            branches:
              only: [ main ]
          requires: [ validate, package ]
      - publish:
          context: runner-deploy
          requires: [ approve-publish ]

executors:
  helm:
    docker:
      - image: cimg/deploy:2023.09
  ruby:
    docker:
      - image: cimg/ruby:3.2.2

jobs:
  validate:
    executor: helm
    resource_class: medium
    steps:
      - checkout
      - run: ./do check-version-bump
      - run: helm lint
      - run: helm template --debug .
      - run: ./do unit-tests
      - notify_failing_main

  package:
    executor: helm
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run: ./do package
      - persist_to_workspace:
          root: .
          paths: [ ./target ]
      - notify_failing_main

  publish:
    executor: ruby
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run: gem install --no-document package_cloud
      - run: ./do publish
      - notify_failing_main

commands:
  notify_failing_main:
    steps:
      - slack/notify:
          channel: runner-alerts
          branch_pattern: main
          event: fail
          template: basic_fail_1
